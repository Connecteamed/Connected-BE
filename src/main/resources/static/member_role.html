<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project Members & Roles 테스트</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 14px; }
    label { font-size: 12px; color: #444; display: block; margin-bottom: 4px; }
    input, textarea, select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; min-width: 220px; }
    button { padding: 9px 12px; border: 1px solid #333; background: #111; color: #fff; border-radius: 8px; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; font-size: 14px; }
    th { background: #fafafa; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #0b0f14; color: #e6edf3; padding: 12px; border-radius: 10px; overflow: auto; }
    .ok { color: #0a7d3b; }
    .bad { color: #b00020; }
    .pill { display:inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; margin-right: 6px; font-size: 12px; }
  </style>
</head>
<body>
  <h2>프로젝트 팀원 목록 & 역할 테스트</h2>
  <div class="muted">
    - GET: /api/projects/{projectId}/members<br/>
    - PATCH: /api/projects/{projectId}/members/{projectMemberId}/roles
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Base URL</label>
        <input id="baseUrl" value="http://localhost:8080" />
      </div>
      <div>
        <label>Project ID</label>
        <input id="projectId" type="number" value="1" />
      </div>
      <div style="margin-top: 18px;">
        <button id="btnLoad">팀원 목록 불러오기</button>
      </div>
    </div>

    <div id="loadStatus" class="muted" style="margin-top:10px;"></div>

    <table id="memberTable" style="display:none;">
      <thead>
        <tr>
          <th>projectMemberId</th>
          <th>memberId</th>
          <th>이름/닉네임</th>
          <th>roles</th>
        </tr>
      </thead>
      <tbody id="memberTbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">역할 할당(PATCH) 테스트</h3>
    <div class="row">
      <div>
        <label>Project Member ID</label>
        <input id="projectMemberId" type="number" value="1" />
      </div>
      <div>
        <label>roleIds (쉼표로 구분)</label>
        <input id="roleIds" value="1,2" />
        <div class="muted">예: 1,2 (designer + ppt)</div>
      </div>
      <div style="margin-top: 18px;">
        <button id="btnPatch">역할 업데이트</button>
      </div>
    </div>

    <div id="patchStatus" class="muted" style="margin-top:10px;"></div>
    <pre id="patchResponse" style="display:none;"></pre>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;">응답 로그</h3>
    <pre id="log"></pre>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function logLine(line) {
    const el = $("log");
    const now = new Date().toISOString();
    el.textContent = `[${now}] ${line}\n` + el.textContent;
  }

  function safeJsonParse(text) {
    try { return JSON.parse(text); } catch { return null; }
  }

  function buildUrl(path) {
    const base = $("baseUrl").value.replace(/\/+$/, "");
    return base + path;
  }

  function parseRoleIds(value) {
    return value
      .split(",")
      .map(s => s.trim())
      .filter(Boolean)
      .map(Number)
      .filter(n => Number.isFinite(n));
  }

  function renderMembers(data) {
    // 기대하는 데이터 모양은 프로젝트에 맞게 다를 수 있습니다.
    // 아래는 가능한 케이스들을 최대한 유연하게 처리합니다.
    const list = Array.isArray(data) ? data
      : (data && Array.isArray(data.data) ? data.data : null);

    const tbody = $("memberTbody");
    tbody.innerHTML = "";

    if (!list || list.length === 0) {
      $("memberTable").style.display = "none";
      $("loadStatus").innerHTML = `<span class="bad">목록이 비어있거나 응답 형태를 해석하지 못했습니다.</span>`;
      return;
    }

    for (const item of list) {
      // 아래 필드명은 구현 DTO에 맞게 필요하면 수정하세요.
      const projectMemberId = item.projectMemberId ?? item.id ?? item.projectMember?.id ?? "-";
      const memberId = item.memberId ?? item.member?.id ?? "-";
      const name = item.name ?? item.memberName ?? item.member?.name ?? item.nickname ?? "-";
      const roles = item.roles ?? item.roleNames ?? item.roleNameList ?? [];

      let roleText = "";
      if (Array.isArray(roles)) {
        roleText = roles.map(r => {
          if (typeof r === "string") return r;
          if (r && typeof r === "object") return (r.roleName ?? r.name ?? r.displayName ?? JSON.stringify(r));
          return String(r);
        }).join(", ");
      } else {
        roleText = String(roles);
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${projectMemberId}</td>
        <td>${memberId}</td>
        <td>${name}</td>
        <td>${roleText ? roleText.split(", ").map(x => `<span class="pill">${x}</span>`).join("") : "-"}</td>
      `;
      tbody.appendChild(tr);
    }

    $("memberTable").style.display = "";
    $("loadStatus").innerHTML = `<span class="ok">목록 로드 성공</span>`;
  }

  async function loadMembers() {
    const projectId = Number($("projectId").value);
    if (!Number.isFinite(projectId) || projectId <= 0) {
      $("loadStatus").innerHTML = `<span class="bad">Project ID를 올바르게 입력해주세요.</span>`;
      return;
    }

    const url = buildUrl(`/api/projects/${projectId}/members`);
    $("btnLoad").disabled = true;
    $("loadStatus").textContent = "불러오는 중...";
    logLine(`GET ${url}`);

    try {
      const res = await fetch(url, { method: "GET" });
      const text = await res.text();
      const json = safeJsonParse(text);

      logLine(`응답 ${res.status}: ${text.slice(0, 500)}`);

      if (!res.ok) {
        $("loadStatus").innerHTML = `<span class="bad">실패 (${res.status})</span>`;
        $("memberTable").style.display = "none";
        return;
      }

      renderMembers(json ?? text);
    } catch (e) {
      $("loadStatus").innerHTML = `<span class="bad">요청 중 오류: ${e?.message ?? e}</span>`;
    } finally {
      $("btnLoad").disabled = false;
    }
  }

  async function patchRoles() {
    const projectId = Number($("projectId").value);
    const projectMemberId = Number($("projectMemberId").value);
    const roleIds = parseRoleIds($("roleIds").value);

    if (!Number.isFinite(projectId) || projectId <= 0) {
      $("patchStatus").innerHTML = `<span class="bad">Project ID를 올바르게 입력해주세요.</span>`;
      return;
    }
    if (!Number.isFinite(projectMemberId) || projectMemberId <= 0) {
      $("patchStatus").innerHTML = `<span class="bad">Project Member ID를 올바르게 입력해주세요.</span>`;
      return;
    }
    if (roleIds.length === 0) {
      $("patchStatus").innerHTML = `<span class="bad">roleIds를 1개 이상 입력해주세요. 예: 1,2</span>`;
      return;
    }

    const url = buildUrl(`/api/projects/${projectId}/members/${projectMemberId}/roles`);
    $("btnPatch").disabled = true;
    $("patchStatus").textContent = "업데이트 중...";
    $("patchResponse").style.display = "none";

    // 서버 DTO에 맞춰 body 키를 바꿔야 할 수 있습니다.
    // 흔한 형태: { "roleIds": [1,2] }
    const body = { roleIds };

    logLine(`PATCH ${url} body=${JSON.stringify(body)}`);

    try {
      const res = await fetch(url, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const text = await res.text();
      logLine(`응답 ${res.status}: ${text.slice(0, 800)}`);

      $("patchResponse").textContent = text;
      $("patchResponse").style.display = "";

      if (!res.ok) {
        $("patchStatus").innerHTML = `<span class="bad">실패 (${res.status})</span>`;
        return;
      }

      $("patchStatus").innerHTML = `<span class="ok">성공 (${res.status})</span>`;
      // 성공하면 목록 다시 로드
      await loadMembers();
    } catch (e) {
      $("patchStatus").innerHTML = `<span class="bad">요청 중 오류: ${e?.message ?? e}</span>`;
    } finally {
      $("btnPatch").disabled = false;
    }
  }

  $("btnLoad").addEventListener("click", loadMembers);
  $("btnPatch").addEventListener("click", patchRoles);
</script>
</body>
</html>
