<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task API 테스트</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --line:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --pill:#f3f4f6;
      --pillText:#374151;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:18px auto;
      padding:0 18px 40px;
    }

    /* card + table */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      margin-top:14px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:14px;
    }
    thead th{
      text-align:left;
      font-weight:600;
      color:#4b5563;
      font-size:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    tbody td{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
    }
    tbody tr:last-child td{border-bottom:none}

    .col-title{width:170px}
    .col-content{width:auto}
    .col-status{width:120px}
    .col-date{width:120px}
    .col-assignee{width:180px}
    .col-actions{width:70px; text-align:right}

    .muted{color:var(--muted); font-size:12px}
    .ellipsis{
      max-width:520px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--pill);
      color:var(--pillText);
      font-size:12px;
    }
    .pill select{
      border:none;
      outline:none;
      background:transparent;
      font-size:12px;
      color:var(--pillText);
      cursor:pointer;
      appearance:none;
      padding-right:10px;
    }

    .btnDel{
      border:none;
      background:transparent;
      color:#9ca3af;
      cursor:pointer;
      font-size:12px;
    }
    .btnDel:hover{color:#ef4444}

    .footerBar{
      display:flex;
      justify-content:flex-end;
      padding:14px 16px;
      background:#fff;
      border-top:1px solid var(--line);
    }
    .btnAdd{
      background:#111827;
      color:white;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }

    /* modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .overlay.open{display:flex}
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border-radius:14px;
      border:1px solid var(--line);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
    }
    .modalHead h3{
      margin:0;
      font-size:14px;
      font-weight:800;
    }
    .modalClose{
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      color:#6b7280;
    }
    .modalBody{padding:14px 16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:12px;
      color:#6b7280;
    }
    input, textarea, select{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:92px; resize:vertical}
    .full{grid-column:1 / -1}
    .modalFoot{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:12px 16px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .btn{
      border:none;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn.secondary{
      background:#f3f4f6;
      color:#374151;
    }
    .btn.primary{
      background:#111827;
      color:#fff;
    }

    /* log (검정 배경 유지) */
    .log{
      margin-top:12px;
      background:#0b1220;
      color:#d1e7ff;
      padding:12px 12px;
      border-radius:12px;
      overflow:auto;
      font-size:12px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <table>
        <thead>
          <tr>
            <th class="col-title">업무명</th>
            <th class="col-content">업무내용</th>
            <th class="col-status">상태</th>
            <th class="col-date">시작일</th>
            <th class="col-date">마감일</th>
            <th class="col-assignee">담당자</th>
            <th class="col-actions"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="footerBar">
        <button class="btnAdd" id="btnOpenCreate">업무 추가</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <!-- Create Modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <h3>업무 추가</h3>
        <button class="modalClose" id="btnClose">✕</button>
      </div>
      <div class="modalBody">
        <div class="grid">
          <div class="field">
            <label>업무명</label>
            <input id="cName" placeholder="예) API 명세서 작성" />
          </div>

          <div class="field">
            <label>상태</label>
            <select id="cStatus">
              <option value="TODO">시작 전</option>
              <option value="IN_PROGRESS">진행 중</option>
              <option value="DONE">완료</option>
            </select>
          </div>

          <div class="field">
            <label>시작일</label>
            <!-- date가 클릭 안 되는 경우가 있어서 text + showPicker로 처리 -->
            <input id="cStart" type="date" />
          </div>

          <div class="field">
            <label>마감일</label>
            <input id="cDue" type="date" />
          </div>

          <div class="field full">
            <label>업무내용</label>
            <textarea id="cContent" placeholder="업무 설명을 적어주세요"></textarea>
          </div>

          <div class="field full">
            <label>담당자 projectMemberId 목록 (쉼표로 구분)</label>
            <input id="cAssignees" placeholder="예) 10,11,12" />
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn secondary" id="btnCancel">취소</button>
        <button class="btn primary" id="btnCreate">생성</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // 여기만 바꾸면 됩니다
    const BASE_URL = "http://localhost:8080";
    const PROJECT_ID = 1;

    const toKDate = (isoOrInstant) => {
      if (!isoOrInstant) return "-";
      const d = new Date(isoOrInstant);
      if (Number.isNaN(d.getTime())) return String(isoOrInstant).slice(0, 10);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}.${m}.${day}`;
    };

    const dateToInstantZulu = (yyyyMMdd) => {
      return new Date(yyyyMMdd + "T00:00:00Z").toISOString();
    };

    const escapeHtml = (s) => {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    };

    const log = (obj) => {
      const el = $("log");
      const text = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      el.textContent = text;
    };

    const api = async (path, opts = {}) => {
      const url = BASE_URL.replace(/\/$/, "") + path;

      const res = await fetch(url, {
        headers: { "Content-Type": "application/json" },
        ...opts
      });

      const text = await res.text();
      let body = null;
      try { body = text ? JSON.parse(text) : null; } catch (e) { body = text; }

      if (!res.ok) throw { status: res.status, body };
      return body;
    };

    const renderRows = (tasks) => {
      const tbody = $("tbody");
      tbody.innerHTML = "";

      tasks.forEach(t => {
        const tr = document.createElement("tr");

        const assignees = (t.assignees || [])
          .map(a => a.memberName || ("PM#" + a.projectMemberId))
          .join(", ") || "-";

        tr.innerHTML = `
          <td class="col-title">
            <div style="font-weight:700; font-size:13px;">${escapeHtml(t.name || "-")}</div>
          </td>
          <td class="col-content">
            <div class="muted ellipsis">${escapeHtml(t.content || "")}</div>
          </td>
          <td class="col-status">
            <span class="pill">
              <select data-action="status" data-id="${t.taskId}">
                <option value="TODO" ${t.status==="TODO"?"selected":""}>시작 전</option>
                <option value="IN_PROGRESS" ${t.status==="IN_PROGRESS"?"selected":""}>진행 중</option>
                <option value="DONE" ${t.status==="DONE"?"selected":""}>완료</option>
              </select>
            </span>
          </td>
          <td class="col-date">${toKDate(t.startDate)}</td>
          <td class="col-date">${toKDate(t.dueDate)}</td>
          <td class="col-assignee">
            <span class="muted">${escapeHtml(assignees)}</span>
          </td>
          <td class="col-actions">
            <button class="btnDel" data-action="delete" data-id="${t.taskId}">삭제</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    };

    const loadTasks = async () => {
      const data = await api(`/api/projects/${PROJECT_ID}/tasks`, { method: "GET" });
      if (data && data.status === "success") {
        renderRows(data.data || []);
      }
      log(data);
    };

    const patchStatus = async (taskId, status) => {
      const data = await api(`/api/tasks/${taskId}/status`, {
        method: "PATCH",
        body: JSON.stringify({ status })
      });
      log(data);
    };

    const deleteTask = async (taskId) => {
      const data = await api(`/api/tasks/${taskId}`, { method: "DELETE" });
      log(data);
    };

    const openModal = () => $("overlay").classList.add("open");
    const closeModal = () => $("overlay").classList.remove("open");

    const ensureDatePickerWorks = (inputEl) => {
      // 일부 환경에서 date input 클릭이 막히는 경우(오버레이/레이아웃 이슈) 대비
      // showPicker 지원 브라우저면 강제로 열어줌
      inputEl.addEventListener("focus", () => {
        if (typeof inputEl.showPicker === "function") {
          try { inputEl.showPicker(); } catch (e) {}
        }
      });
      inputEl.addEventListener("click", () => {
        if (typeof inputEl.showPicker === "function") {
          try { inputEl.showPicker(); } catch (e) {}
        }
      });
    };

    const createTask = async () => {
      const name = $("cName").value.trim();
      const content = $("cContent").value.trim();
      const start = $("cStart").value;
      const due = $("cDue").value;
      const assigneesRaw = $("cAssignees").value.trim();

      const assigneeProjectMemberIds = assigneesRaw
        ? assigneesRaw.split(",").map(s => Number(s.trim())).filter(n => !Number.isNaN(n))
        : [];

      const payload = {
        name,
        content,
        startDate: start ? dateToInstantZulu(start) : null,
        dueDate: due ? dateToInstantZulu(due) : null,
        assigneeProjectMemberIds
      };

      const data = await api(`/api/projects/${PROJECT_ID}/tasks`, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      log(data);
      await loadTasks();
      closeModal();
    };

    // events
    $("btnOpenCreate").addEventListener("click", () => {
      // date 기본값
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const dd = String(today.getDate()).padStart(2,"0");
      const t = `${yyyy}-${mm}-${dd}`;
      if (!$("cStart").value) $("cStart").value = t;
      if (!$("cDue").value) $("cDue").value = t;

      openModal();
      // 모달 열린 다음 date picker 강제 연결
      ensureDatePickerWorks($("cStart"));
      ensureDatePickerWorks($("cDue"));
    });

    $("btnClose").addEventListener("click", closeModal);
    $("btnCancel").addEventListener("click", closeModal);
    $("overlay").addEventListener("click", (e) => {
      if (e.target === $("overlay")) closeModal();
    });

    $("btnCreate").addEventListener("click", async () => {
      try {
        await createTask();
      } catch (e) {
        log(e);
        alert("생성 실패: 로그 확인");
      }
    });

    $("tbody").addEventListener("change", async (e) => {
      const target = e.target;
      if (target && target.matches('select[data-action="status"]')) {
        const taskId = target.getAttribute("data-id");
        const status = target.value;
        try {
          await patchStatus(taskId, status);
        } catch (err) {
          log(err);
          alert("상태 변경 실패: 로그 확인");
        }
      }
    });

    $("tbody").addEventListener("click", async (e) => {
      const btn = e.target;
      if (btn && btn.matches('button[data-action="delete"]')) {
        const taskId = btn.getAttribute("data-id");
        if (!confirm("삭제하시겠습니까?")) return;
        try {
          await deleteTask(taskId);
          await loadTasks();
        } catch (err) {
          log(err);
          alert("삭제 실패: 로그 확인");
        }
      }
    });

    // init
    loadTasks().catch(err => log(err));
  </script>
</body>
</html>
