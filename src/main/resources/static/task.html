<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task API 테스트</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --line:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;

      --pill:#f3f4f6;
      --pillText:#374151;

      --black:#0b1220;
      --blueText:#d1e7ff;

      --btn:#111827;
      --btnText:#ffffff;
      --btn2:#f3f4f6;
      --btn2Text:#374151;

      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:18px auto;
      padding:0 18px 40px;
    }

    /* tabs */
    .tabs{
      display:flex;
      gap:22px;
      align-items:center;
      padding:14px 6px;
      border-bottom:1px solid var(--line);
      color:#374151;
      font-size:14px;
      user-select:none;
    }
    .tab{
      padding:10px 2px;
      border-bottom:2px solid transparent;
      cursor:pointer;
      white-space:nowrap;
    }
    .tab.active{
      color:#111827;
      border-bottom-color:#111827;
      font-weight:700;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      margin-top:14px;
    }

    /* table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:14px;
    }
    thead th{
      text-align:left;
      font-weight:600;
      color:#4b5563;
      font-size:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    tbody td{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
    }
    tbody tr:last-child td{border-bottom:none}

    .col-title{width:170px}
    .col-content{width:auto}
    .col-status{width:140px}
    .col-date{width:120px}
    .col-assignee{width:200px}
    .col-actions{width:120px; text-align:right}

    .muted{color:var(--muted); font-size:12px}
    .ellipsis{
      max-width:520px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--pill);
      color:var(--pillText);
      font-size:12px;
    }
    .pill select{
      border:none;
      outline:none;
      background:transparent;
      font-size:12px;
      color:var(--pillText);
      cursor:pointer;
      appearance:none;
      padding-right:10px;
    }

    .btnDel{
      border:none;
      background:transparent;
      color:#9ca3af;
      cursor:pointer;
      font-size:12px;
      margin-left:10px;
    }
    .btnDel:hover{color:var(--danger)}

    .btnLink{
      border:none;
      background:transparent;
      color:#6b7280;
      cursor:pointer;
      font-size:12px;
      text-decoration:underline;
    }
    .btnLink:hover{color:#111827}

    .footerBar{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:14px 16px;
      background:#fff;
      border-top:1px solid var(--line);
    }
    .btn{
      border:none;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .btn.primary{
      background:var(--btn);
      color:var(--btnText);
    }
    .btn.secondary{
      background:var(--btn2);
      color:var(--btn2Text);
    }

    /* forms */
    .formRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:220px;
    }
    label{
      font-size:12px;
      color:#6b7280;
    }
    input, textarea, select{
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:80px; resize:vertical}
    .field.small{min-width:160px}
    .field.wide{min-width:360px}

    /* modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .overlay.open{display:flex}
    .modal{
      width:min(860px, 100%);
      background:#fff;
      border-radius:14px;
      border:1px solid var(--line);
      overflow:hidden;
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
    }
    .modalHead h3{
      margin:0;
      font-size:14px;
      font-weight:800;
    }
    .modalClose{
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      color:#6b7280;
    }
    .modalBody{padding:14px 16px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .full{grid-column:1 / -1}
    .modalFoot{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:12px 16px;
      border-top:1px solid var(--line);
      background:#fff;
    }

    /* log */
    .log{
      margin-top:12px;
      background:var(--black);
      color:var(--blueText);
      padding:12px 12px;
      border-radius:12px;
      overflow:auto;
      font-size:12px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }

    .hint{
      padding:0 16px 14px;
      font-size:12px;
      color:#6b7280;
      background:#fff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="tabs">
      <div class="tab active">업무목록</div>
    </div>

    <div class="card">
      <!-- 상단 설정 + 단건 테스트 -->
      <div class="formRow">
        <div class="field small">
          <label>Base URL</label>
          <input id="baseUrl" value="http://localhost:8080" />
        </div>
        <div class="field small">
          <label>projectId</label>
          <input id="projectId" value="1" />
        </div>
        <div class="field wide">
          <label>taskId (UUID)</label>
          <input id="taskId" placeholder="예) 2d9b0a5b-...." />
        </div>

        <button class="btn secondary" id="btnList">목록 GET</button>
        <button class="btn secondary" id="btnDetail">상세 GET</button>
        <button class="btn secondary" id="btnDeleteOne">삭제 DELETE</button>
      </div>

      <div class="hint">
        목록에서 행 클릭하면 taskId가 자동으로 채워집니다. 상태 변경은 드롭다운으로 PATCH /status 호출합니다.
        일정 변경(PATCH /tasks/{taskId})과 담당자 변경(PATCH /assignees)은 아래 "단건 수정"에서 실행할 수 있습니다.
      </div>

      <!-- 테이블 -->
      <table>
        <thead>
          <tr>
            <th class="col-title">업무명</th>
            <th class="col-content">업무내용</th>
            <th class="col-status">상태</th>
            <th class="col-date">시작일</th>
            <th class="col-date">마감일</th>
            <th class="col-assignee">담당자</th>
            <th class="col-actions"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="footerBar">
        <button class="btn primary" id="btnOpenCreate">업무 추가 POST</button>
      </div>
    </div>

    <!-- 단건 수정 카드 -->
    <div class="card" style="margin-top:14px;">
      <div class="formRow">
        <div class="field">
          <label>일정 변경 (PATCH /api/tasks/{taskId}) - startDate</label>
          <input id="uStart" type="date" />
        </div>
        <div class="field">
          <label>일정 변경 (PATCH /api/tasks/{taskId}) - dueDate</label>
          <input id="uDue" type="date" />
        </div>
        <button class="btn secondary" id="btnPatchSchedule">일정 PATCH</button>
      </div>

      <div class="formRow" style="border-bottom:none;">
        <div class="field wide">
          <label>담당자 변경 (PATCH /api/tasks/{taskId}/assignees) - projectMemberIds</label>
          <input id="uAssignees" placeholder="예) 10,11,12" />
        </div>
        <button class="btn secondary" id="btnPatchAssignees">담당자 PATCH</button>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <!-- Create Modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modalHead">
        <h3>업무 추가</h3>
        <button class="modalClose" id="btnClose">✕</button>
      </div>
      <div class="modalBody">
        <div class="grid">
          <div class="field">
            <label>업무명</label>
            <input id="cName" placeholder="예) API 명세서 작성" />
          </div>

          <div class="field">
            <label>상태 (참고용: 생성은 TODO로 시작해도 됩니다)</label>
            <select id="cStatus" disabled>
              <option value="TODO" selected>시작 전</option>
              <option value="IN_PROGRESS">진행 중</option>
              <option value="DONE">완료</option>
            </select>
          </div>

          <div class="field">
            <label>시작일</label>
            <input id="cStart" type="date" />
          </div>

          <div class="field">
            <label>마감일</label>
            <input id="cDue" type="date" />
          </div>

          <div class="field full">
            <label>업무내용</label>
            <textarea id="cContent" placeholder="업무 설명을 적어주세요"></textarea>
          </div>

          <div class="field full">
            <label>담당자 projectMemberId 목록 (쉼표로 구분)</label>
            <input id="cAssignees" placeholder="예) 10,11,12" />
          </div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn secondary" id="btnCancel">취소</button>
        <button class="btn primary" id="btnCreate">생성 POST</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const toKDate = (isoOrInstant) => {
      if (!isoOrInstant) return "-";
      const d = new Date(isoOrInstant);
      if (Number.isNaN(d.getTime())) return String(isoOrInstant).slice(0, 10);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}.${m}.${day}`;
    };

    const dateToInstantZulu = (yyyyMMdd) => {
      return new Date(yyyyMMdd + "T00:00:00Z").toISOString();
    };

    const escapeHtml = (s) => {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    };

    const log = (obj) => {
      const el = $("log");
      const text = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      el.textContent = text;
    };

    const api = async (path, opts = {}) => {
      const baseUrl = $("baseUrl").value.trim().replace(/\/$/, "");
      const url = baseUrl + path;

      const res = await fetch(url, {
        headers: { "Content-Type": "application/json" },
        ...opts
      });

      const text = await res.text();
      let body = null;
      try { body = text ? JSON.parse(text) : null; } catch (e) { body = text; }

      if (!res.ok) throw { status: res.status, body };
      return body;
    };

    const renderRows = (tasks) => {
      const tbody = $("tbody");
      tbody.innerHTML = "";

      tasks.forEach(t => {
        const tr = document.createElement("tr");

        const assignees = (t.assignees || [])
          .map(a => a.memberName || ("PM#" + a.projectMemberId))
          .join(", ") || "-";

        tr.innerHTML = `
          <td class="col-title">
            <div style="font-weight:700; font-size:13px;">${escapeHtml(t.name || "-")}</div>
          </td>
          <td class="col-content">
            <div class="muted ellipsis">${escapeHtml(t.content || "")}</div>
          </td>
          <td class="col-status">
            <span class="pill">
              <select data-action="status" data-id="${t.taskId}">
                <option value="TODO" ${t.status==="TODO"?"selected":""}>시작 전</option>
                <option value="IN_PROGRESS" ${t.status==="IN_PROGRESS"?"selected":""}>진행 중</option>
                <option value="DONE" ${t.status==="DONE"?"selected":""}>완료</option>
              </select>
            </span>
          </td>
          <td class="col-date">${toKDate(t.startDate)}</td>
          <td class="col-date">${toKDate(t.dueDate)}</td>
          <td class="col-assignee">
            <span class="muted">${escapeHtml(assignees)}</span>
          </td>
          <td class="col-actions">
            <button class="btnLink" data-action="pick" data-id="${t.taskId}">선택</button>
            <button class="btnDel" data-action="delete" data-id="${t.taskId}">삭제</button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    };

    const getProjectId = () => $("projectId").value.trim();
    const getTaskId = () => $("taskId").value.trim();

    const loadTasks = async () => {
      const data = await api(`/api/projects/${getProjectId()}/tasks`, { method: "GET" });
      if (data && data.status === "success") {
        renderRows(data.data || []);
      }
      log(data);
    };

    const getTaskDetail = async () => {
      const taskId = getTaskId();
      if (!taskId) return alert("taskId를 입력하세요.");
      const data = await api(`/api/tasks/${taskId}/detail`, { method: "GET" });
      log(data);

      // 상세에서 일정값을 채워줌(있으면)
      if (data && data.status === "success" && data.data) {
        const sd = data.data.startDate ? String(data.data.startDate).slice(0,10) : "";
        const dd = data.data.dueDate ? String(data.data.dueDate).slice(0,10) : "";
        if (sd) $("uStart").value = sd;
        if (dd) $("uDue").value = dd;
      }
    };

    const patchStatus = async (taskId, status) => {
      const data = await api(`/api/tasks/${taskId}/status`, {
        method: "PATCH",
        body: JSON.stringify({ status })
      });
      log(data);
    };

    const patchSchedule = async () => {
      const taskId = getTaskId();
      if (!taskId) return alert("taskId를 입력하세요.");

      const start = $("uStart").value;
      const due = $("uDue").value;
      if (!start || !due) return alert("startDate / dueDate를 모두 입력하세요.");

      const payload = {
        startDate: dateToInstantZulu(start),
        dueDate: dateToInstantZulu(due)
      };

      const data = await api(`/api/tasks/${taskId}/schedule`, {
        method: "PATCH",
        body: JSON.stringify(payload)
      });
      log(data);
      await loadTasks();
    };

    const patchAssignees = async () => {
      const taskId = getTaskId();
      if (!taskId) return alert("taskId를 입력하세요.");

      const raw = $("uAssignees").value.trim();
      const ids = raw
        ? raw.split(",").map(s => Number(s.trim())).filter(n => !Number.isNaN(n))
        : [];

      const data = await api(`/api/tasks/${taskId}/assignees`, {
        method: "PATCH",
        body: JSON.stringify({ assigneeProjectMemberIds: ids })
      });
      log(data);
      await loadTasks();
    };

    const deleteTask = async (taskId) => {
      const data = await api(`/api/tasks/${taskId}`, { method: "DELETE" });
      log(data);
      await loadTasks();
    };

    const createTask = async () => {
      const name = $("cName").value.trim();
      const content = $("cContent").value.trim();
      const start = $("cStart").value;
      const due = $("cDue").value;
      const assigneesRaw = $("cAssignees").value.trim();

      if (!name || !content) return alert("업무명/업무내용을 입력하세요.");
      if (!start || !due) return alert("시작일/마감일을 입력하세요.");

      const assigneeProjectMemberIds = assigneesRaw
        ? assigneesRaw.split(",").map(s => Number(s.trim())).filter(n => !Number.isNaN(n))
        : [];

      const payload = {
        name,
        content,
        startDate: dateToInstantZulu(start),
        dueDate: dateToInstantZulu(due),
        assigneeProjectMemberIds
      };

      const data = await api(`/api/projects/${getProjectId()}/tasks`, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      log(data);
      await loadTasks();
      closeModal();
    };

    const openModal = () => $("overlay").classList.add("open");
    const closeModal = () => $("overlay").classList.remove("open");

    const ensureDatePickerWorks = (inputEl) => {
      inputEl.addEventListener("focus", () => {
        if (typeof inputEl.showPicker === "function") {
          try { inputEl.showPicker(); } catch (e) {}
        }
      });
      inputEl.addEventListener("click", () => {
        if (typeof inputEl.showPicker === "function") {
          try { inputEl.showPicker(); } catch (e) {}
        }
      });
    };

    // ---- events ----
    $("btnList").addEventListener("click", () => loadTasks().catch(err => log(err)));
    $("btnDetail").addEventListener("click", () => getTaskDetail().catch(err => log(err)));

    $("btnDeleteOne").addEventListener("click", async () => {
      const taskId = getTaskId();
      if (!taskId) return alert("taskId를 입력하세요.");
      if (!confirm("삭제하시겠습니까?")) return;
      try { await deleteTask(taskId); } catch (e) { log(e); }
    });

    $("btnPatchSchedule").addEventListener("click", () => patchSchedule().catch(err => log(err)));
    $("btnPatchAssignees").addEventListener("click", () => patchAssignees().catch(err => log(err)));

    $("btnOpenCreate").addEventListener("click", () => {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const dd = String(today.getDate()).padStart(2,"0");
      const t = `${yyyy}-${mm}-${dd}`;
      if (!$("cStart").value) $("cStart").value = t;
      if (!$("cDue").value) $("cDue").value = t;

      openModal();
      ensureDatePickerWorks($("cStart"));
      ensureDatePickerWorks($("cDue"));
    });

    $("btnClose").addEventListener("click", closeModal);
    $("btnCancel").addEventListener("click", closeModal);
    $("overlay").addEventListener("click", (e) => {
      if (e.target === $("overlay")) closeModal();
    });

    $("btnCreate").addEventListener("click", () => createTask().catch(err => log(err)));

    $("tbody").addEventListener("change", async (e) => {
      const target = e.target;
      if (target && target.matches('select[data-action="status"]')) {
        const taskId = target.getAttribute("data-id");
        const status = target.value;
        try {
          await patchStatus(taskId, status);
        } catch (err) {
          log(err);
          alert("상태 변경 실패: 로그 확인");
        }
      }
    });

    $("tbody").addEventListener("click", async (e) => {
      const el = e.target;
      if (!el) return;

      if (el.matches('button[data-action="pick"]')) {
        const taskId = el.getAttribute("data-id");
        $("taskId").value = taskId;
        // 단건 상세도 같이 불러와서 일정 입력칸 채우기
        try { await getTaskDetail(); } catch (err) { log(err); }
        return;
      }

      if (el.matches('button[data-action="delete"]')) {
        const taskId = el.getAttribute("data-id");
        if (!confirm("삭제하시겠습니까?")) return;
        try { await deleteTask(taskId); } catch (err) { log(err); }
        return;
      }
    });

    // date pickers (단건 수정 영역도 클릭 잘 되게)
    ensureDatePickerWorks($("uStart"));
    ensureDatePickerWorks($("uDue"));

    // init
    loadTasks().catch(err => log(err));
  </script>
</body>
</html>
